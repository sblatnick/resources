#!/bin/bash
#Kubernetes (k8s) helper scripts
CONFIG=~/.kate
shopt -s extglob

context=$(kubectl config current-context)
source $CONFIG 2>/dev/null #get current namespace
contexts=$(kubectl config get-contexts -o=name | tr $'\n' '|')
namespaces=$(kubectl get namespace -o name | sed 's/namespace\///' | tr $'\n' '|')

case "${1}" in
  '') #list contexts and namespaces
      IFS='|'
      for ctx in ${contexts}
      do
        if [ "$ctx" == "$context" ];then
          echo -e "\033[32;1m${ctx}\033[36m*\033[0m"
          kubectl get namespace -o name | sed 's/namespace\///' |
          while read ns
          do
            if [ "$ns" == "$namespace" ];then
              echo -e "  \033[34;1m${ns}\033[36m*\033[0m"
            else
              echo -e "  \033[34;1m${ns}\033[0m"
            fi
          done
        else
          echo -e "\033[32;1m${ctx}\033[0m"
        fi
      done
    ;;
  @(${contexts}))
        kubectl config use-context $1 2>/dev/null
        echo -en "Switching to context \033[32;1m${1}\033[0m";
        trap "$0 default;exit" ERR
        shift
        namespace=$1
        shift
        trap - ERR
        $0 $namespace
      exit
    ;;
  @(${namespaces}))
        echo "namespace=\"${1}\"" > ${CONFIG}
        echo -e " namespace \033[34;1m${1}\033[0m";
      exit
    ;;
  *)
      kubectl -n ${namespace} $@
    ;;
esac

