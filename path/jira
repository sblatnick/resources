#!/bin/bash
source ~/.bashrc #source main bashrc so we can add to the environment outside of repo
source ${BASH_SOURCE%/path/*}/config/bashrc

TIMESTAMP=false
REQUEST=$1
shift

##Main
case "${REQUEST}" in
  help|h|'') ##This help documentation
      document_title "Jira Tools" "method" "json file" "api path"
      document ${BASH_SOURCE}
      document_header "Environment Variables"
      de "JIRA" "API endpoint"
      document_header "Examples"
      de "${0##*/}" "GET issue/PROJECT-001" "Retrieve issue"
      de "${0##*/}" "POST create.json issue" "Create new issue"
      de "${0##*/}" "POST block.json issue/PROJECT-001/transitions" "Block issue"
      de "${0##*/}" "PUT fields.json issue/PROJECT-001" "Set fields"
      echo ""
      exit
    ;;
  POST|PUT) #[json file]#request against jira
      if [ ! -f ${1} ];then
        error "No json file at '$1'"
      fi
      json="-H 'Content-Type: application/json' -d '@${1}'"
      shift
    ;;
  GET|DELETE) ##requests against jira
    ;;
  *)
      error "Unsupported request: ${REQUEST}"
    ;;
esac

tmpdir
response=${tmp}/response.json

code=$(eval curl -o ${response} -w "%{http_code}" -n -X $REQUEST $json --silent "${JIRA}/$@")
if [ $? -gt 0 ];then
  warn "error response"
  cat ${response}
else
  echo "STATUS: ${code}"
  cat ${response} | python -mjson.tool
  if [ $? -gt 0 ];then
    warn "JSON not found in response"
    cat ${response}
  fi
fi
