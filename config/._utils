#!/bin/bash
#Utility functions

shopt -s expand_aliases extglob

#------------------------------------UTILS-------------------------------------#

function coalesce() {
  while [ $# -gt 0 ]; do
    case "$1" in
      'null'|'false'|*( ))
        ;;
      *)
          echo $1
          return
        ;;
    esac
    shift
  done
  echo ''
}

function pipe() {
  if [ -t 0 ];then
    if [ "$#" -lt 1 ];then
      echo -e "Usage: stdin | ${BIN-pipe} [lines|file]"
      return
    else
      while [ -n "$1" ]; do
        if [ -f $1 ];then
          cat $1 |
          while read pipe
          do
            ${ACTION-echo} "$pipe"
          done
        else
          ${ACTION-echo} "$1"
        fi
        shift
      done
    fi
  else
    while IFS= read pipe
    do
      ${ACTION-echo} "$pipe"
    done
  fi
}

function min() {
  BIN='min' pipe $@ | sort -n | head -n 1
}

function max() {
  BIN='max' pipe $@ | sort -n | tail -n 1
}

function len() {
  expr length $@
}

function minlen() {
  BIN='max' ACTION='len' pipe $@ | sort -n | head -n 1
}

function maxlen() {
  BIN='max' ACTION='len' pipe $@ | sort -n | tail -n 1
}

function big() {
  du -sx * 2>/dev/null | sort -r -n | head
}

function insert() {
  if [ "$#" -lt 3 ];then
    echo -e "Usage: insert [line number] [text] [file]"
    return
  fi
  local line=$1
  shift
  local text=$1
  shift
  local file=$1
  shift
  sed -i ${line}'{/'${text:0:3}'/! i\'${text}'
}' ${file}
}

function document() {
  grep -Eo '^##.*$' $1 |
  while read section
  do
    echo ""
    echo -e "  \033[1m${section#\#\#}\033[0m"
    sed -n "/^${section}\$/,/^\}\$/ p" $1 | grep -Eo '[^ (]+\)\s+#.*$' | \
    while read help
    do
      params=${help#*#}
      params=${params%%#*}
      if [ -z "${params}" ];then
        params="$(grep -A 1 -F "${help}" $1 | tail -n 1 | grep 'trap' | grep -Eo '\[[^]]*\]' | tr $'\n' ' ')"
      fi
      col=$(printf "\033[34;1m%s\033[0m %s" "${help%%)*#*}" "${params}")
      printf "    %-60s %s\n" "${col}" "${help##*#}"
      #printf "    \033[34;1m%-15s\033[0m %s\n" "${help%%)*#*}" "${help#*#}"
    done
  done
}

function complete_section() {
  section=$1
  shift

  if [ -n "${section}" ];then
    COMPREPLY+=($(compgen -W "$(sed -n "/^${section}\$/,/^\}\$/ p" $1 | grep -Eo '[^ (]+\)\s+#.*$' | sed 's/))* .*$//' | grep -Ev '[\$\*]' | tr '|' $'\n')" -- "${COMP_WORDS[${COMP_CWORD}]}"))
  fi
}

function complete_sections() {
  for section in $(grep -Eom 2 '^##.*$' $1)
  do
    complete_section "${section}" $1
  done
}

function complete_pwd() {
  COMPREPLY=($(compgen -f  -- "${COMP_WORDS[${COMP_CWORD}]}" | xargs -I {} bash -c 'if [ -d {} ];then echo {}/;else echo {}; fi'))
}

